# Containerd Registry Mirror

For airgap installations, K0rdentd configures containerd to use the local registry as a mirror for external registries.

## Overview

When K0s starts in airgap mode, its underlying containerd runtime attempts to pull system images from internet registries (`registry.k8s.io`, `quay.io`). Since the airgap environment has no internet access, these pulls would fail.

The solution is to configure containerd to use the local registry as a mirror.

## Architecture

### Directory Structure

```
/etc/k0s/
├── k0s.yaml                           # k0s cluster configuration (existing)
├── containerd.toml                    # Generated by k0s (managed by k0s)
└── containerd.d/                      # Drop-in configuration directory
    ├── cri-registry.toml              # Containerd CRI registry config (NEW)
    └── certs.d/                       # Registry hosts configuration (NEW)
        ├── registry.k8s.io/
        │   └── hosts.toml             # Mirror config for registry.k8s.io
        └── quay.io/
            └── hosts.toml             # Mirror config for quay.io
```

## Configuration Files

### cri-registry.toml

Tells containerd to look for registry-specific configuration:

```toml
version = 2

[plugins."io.containerd.grpc.v1.cri".registry]
config_path = "/etc/k0s/containerd.d/certs.d"
```

### hosts.toml (per registry)

Configures the local registry as a mirror:

```toml
server = "https://registry.k8s.io"

[host."http://127.0.0.1:5000"]
  capabilities = ["pull", "resolve"]
```

## Implementation

### Setup Function

```go
// SetupContainerdMirror configures containerd to use the local registry as mirror
func SetupContainerdMirror(mirrorAddr string) error {
    // Create directories
    if err := os.MkdirAll(CertsDir, 0755); err != nil {
        return fmt.Errorf("failed to create certs.d directory: %w", err)
    }
    
    // Write CRI registry config
    if err := os.WriteFile(CRIRegistryConfigPath, []byte(CRIRegistryConfig()), 0644); err != nil {
        return fmt.Errorf("failed to write CRI registry config: %w", err)
    }
    
    // Configure mirrors for known registries
    registries := []string{"registry.k8s.io", "quay.io"}
    for _, registry := range registries {
        regDir := filepath.Join(CertsDir, registry)
        if err := os.MkdirAll(regDir, 0755); err != nil {
            return fmt.Errorf("failed to create registry dir for %s: %w", registry, err)
        }
        
        hostsPath := filepath.Join(regDir, "hosts.toml")
        hostsContent := HostsConfig(registry, mirrorAddr)
        if err := os.WriteFile(hostsPath, []byte(hostsContent), 0644); err != nil {
            return fmt.Errorf("failed to write hosts.toml for %s: %w", registry, err)
        }
    }
    
    return nil
}
```

## Timing

The containerd configuration must be in place **before** K0s starts:

1. Extract K0s binary to `/usr/local/bin/k0s`
2. **Configure containerd registry mirror**
3. Write K0s configuration to `/etc/k0s/k0s.yaml`
4. Run `k0s install controller --enable-worker`
5. Start K0s service

## Supported Registries

| Registry | Purpose |
|----------|---------|
| `registry.k8s.io` | Kubernetes system images |
| `quay.io` | K0s components (Calico, metrics-server) |
| `docker.io` | Third-party images (optional) |
| `gcr.io` | Google Container Registry images (optional) |

## Multi-Worker Configuration

For multi-worker clusters, use the bootstrap node's reachable IP:

```toml
# For multi-worker: use reachable IP instead of localhost
[host."http://192.168.1.10:5000"]
  capabilities = ["pull", "resolve"]
```

### Worker Node Setup

On worker nodes:

```bash
BOOTSTRAP_IP="192.168.1.10"

sudo mkdir -p /etc/k0s/containerd.d/certs.d/registry.k8s.io
sudo mkdir -p /etc/k0s/containerd.d/certs.d/quay.io

cat <<EOF | sudo tee /etc/k0s/containerd.d/certs.d/registry.k8s.io/hosts.toml
server = "https://registry.k8s.io"
[host."http://${BOOTSTRAP_IP}:5000"]
  capabilities = ["pull", "resolve"]
EOF

cat <<EOF | sudo tee /etc/k0s/containerd.d/certs.d/quay.io/hosts.toml
server = "https://quay.io"
[host."http://${BOOTSTRAP_IP}:5000"]
  capabilities = ["pull", "resolve"]
EOF
```

## Verification

After K0s starts, verify the configuration:

```bash
# Check containerd configuration
cat /etc/k0s/containerd.d/cri-registry.toml

# Check registry hosts
cat /etc/k0s/containerd.d/certs.d/quay.io/hosts.toml
cat /etc/k0s/containerd.d/certs.d/registry.k8s.io/hosts.toml

# Verify images are pulled from local registry
sudo k0s kubectl get pods -A
# All pods should be running without image pull errors
```

## Troubleshooting

### Image Pull Errors

**Symptom**: Pods stuck in ImagePullBackOff.

**Solution**:

```bash
# Verify mirror configuration
cat /etc/k0s/containerd.d/certs.d/quay.io/hosts.toml

# Verify registry is accessible
curl http://localhost:5000/v2/_catalog

# Restart K0s to pick up configuration
sudo k0s restart
```

### Configuration Not Applied

**Symptom**: Configuration exists but images still fail.

**Solution**:

```bash
# Check K0s logs
sudo journalctl -u k0scontroller -f

# Verify containerd picked up config
sudo k0s kubectl get nodes
```

## References

- [K0s Runtime Documentation](https://docs.k0sproject.io/stable/runtime/)
- [K0s Airgap Installation](https://docs.k0sproject.io/stable/airgap-install/)
- [Containerd Registry Configuration](https://github.com/containerd/containerd/blob/main/docs/hosts.md)
