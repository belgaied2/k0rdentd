# Architecture: Containerd Registry Mirror Configuration for Airgap

## Problem Statement

When k0s starts in airgap mode, its underlying containerd runtime attempts to pull system images from internet registries (`registry.k8s.io`, `quay.io`). Since the airgap environment has no internet access, these pulls fail.

The local OCI registry running at `localhost:5000` contains all required images, but containerd is not configured to use it as a mirror.

## Solution Overview

Configure containerd to use the local registry as a mirror for all external registries. This is done through:

1. **Containerd drop-in configuration** at `/etc/k0s/containerd.d/cri-registry.toml`
2. **Registry hosts configuration** at `/etc/k0s/containerd.d/certs.d/<registry>/hosts.toml`

## Architecture

### Directory Structure

```
/etc/k0s/
├── k0s.yaml                           # k0s cluster configuration (existing)
├── containerd.toml                    # Generated by k0s (managed by k0s)
└── containerd.d/                      # Drop-in configuration directory
    ├── cri-registry.toml              # Containerd CRI registry config (NEW)
    └── certs.d/                       # Registry hosts configuration (NEW)
        ├── registry.k8s.io/
        │   └── hosts.toml             # Mirror config for registry.k8s.io
        └── quay.io/
            └── hosts.toml             # Mirror config for quay.io
```

### Configuration Files

#### 1. `/etc/k0s/containerd.d/cri-registry.toml`

This file tells containerd to look for registry-specific configuration in the `certs.d` directory:

```toml
version = 2

[plugins."io.containerd.grpc.v1.cri".registry]
config_path = "/etc/k0s/containerd.d/certs.d"
```

#### 2. `/etc/k0s/containerd.d/certs.d/registry.k8s.io/hosts.toml`

Configures the local registry as a mirror for `registry.k8s.io`:

```toml
server = "https://registry.k8s.io"

[host."http://127.0.0.1:5000"]
  capabilities = ["pull", "resolve"]
```

#### 3. `/etc/k0s/containerd.d/certs.d/quay.io/hosts.toml`

Configures the local registry as a mirror for `quay.io`:

```toml
server = "https://quay.io"

[host."http://127.0.0.1:5000"]
  capabilities = ["pull", "resolve"]
```

### Multi-Worker Consideration

For multi-worker clusters, the registry address must be reachable from all nodes:

```toml
# For multi-worker: use reachable IP instead of localhost
[host."http://192.168.1.10:5000"]
  capabilities = ["pull", "resolve"]
```

## Implementation Plan

### Phase 1: Create Containerd Configuration Package

**New File**: `internal/airgap/containerd/config.go`

```go
package containerd

import (
    "fmt"
    "os"
    "path/filepath"
)

const (
    // ContainerdDropInDir is the directory for containerd drop-in configs
    ContainerdDropInDir = "/etc/k0s/containerd.d"
    
    // CertsDir is the directory for registry host configurations
    CertsDir = "/etc/k0s/containerd.d/certs.d"
    
    // CRIRegistryConfigPath is the path to the CRI registry config
    CRIRegistryConfigPath = "/etc/k0s/containerd.d/cri-registry.toml"
)

// CRIRegistryConfig returns the content of the CRI registry config
func CRIRegistryConfig() string {
    return `version = 2

[plugins."io.containerd.grpc.v1.cri".registry]
config_path = "/etc/k0s/containerd.d/certs.d"
`
}

// HostsConfig returns the content of a hosts.toml for a given registry
// registry: the upstream registry (e.g., "quay.io", "registry.k8s.io")
// mirrorAddr: the local registry address (e.g., "127.0.0.1:5000")
func HostsConfig(registry, mirrorAddr string) string {
    return fmt.Sprintf(`server = "https://%s"

[host."http://%s"]
  capabilities = ["pull", "resolve"]
`, registry, mirrorAddr)
}

// SetupContainerdMirror configures containerd to use the local registry as mirror
func SetupContainerdMirror(mirrorAddr string) error {
    // Create directories
    if err := os.MkdirAll(CertsDir, 0755); err != nil {
        return fmt.Errorf("failed to create certs.d directory: %w", err)
    }
    
    // Write CRI registry config
    if err := os.WriteFile(CRIRegistryConfigPath, []byte(CRIRegistryConfig()), 0644); err != nil {
        return fmt.Errorf("failed to write CRI registry config: %w", err)
    }
    
    // Configure mirrors for known registries
    registries := []string{"registry.k8s.io", "quay.io"}
    for _, registry := range registries {
        regDir := filepath.Join(CertsDir, registry)
        if err := os.MkdirAll(regDir, 0755); err != nil {
            return fmt.Errorf("failed to create registry dir for %s: %w", registry, err)
        }
        
        hostsPath := filepath.Join(regDir, "hosts.toml")
        hostsContent := HostsConfig(registry, mirrorAddr)
        if err := os.WriteFile(hostsPath, []byte(hostsContent), 0644); err != nil {
            return fmt.Errorf("failed to write hosts.toml for %s: %w", registry, err)
        }
    }
    
    return nil
}
```

### Phase 2: Integrate with Airgap Installer

**Modify**: `internal/airgap/installer.go`

Add a new step before k0s installation:

```go
// Step 4: Configure containerd registry mirror
logger.Info("Configuring containerd registry mirror...")
mirrorAddr := i.GetRegistryAddress()
if err := containerd.SetupContainerdMirror(mirrorAddr); err != nil {
    return fmt.Errorf("failed to configure containerd mirror: %w", err)
}
logger.Info("✓ Containerd registry mirror configured")
```

### Phase 3: Timing Considerations

The containerd configuration must be in place **before** k0s starts. The installation sequence should be:

1. Extract k0s binary to `/usr/local/bin/k0s`
2. **Configure containerd registry mirror** (NEW)
3. Write k0s configuration to `/etc/k0s/k0s.yaml`
4. Run `k0s install controller --enable-worker`
5. Start k0s service

### Phase 4: Verification

After k0s starts, verify the configuration:

```bash
# Check containerd configuration
cat /etc/k0s/containerd.d/cri-registry.toml

# Check registry hosts
cat /etc/k0s/containerd.d/certs.d/quay.io/hosts.toml
cat /etc/k0s/containerd.d/certs.d/registry.k8s.io/hosts.toml

# Verify images are pulled from local registry
k0s kubectl get pods -A
# All pods should be running without image pull errors
```

## Additional Registries

The k0rdent bundle may include images from additional registries. Based on the bundle catalog, we should also configure mirrors for:

| Registry | Purpose |
|----------|---------|
| `registry.k8s.io` | Kubernetes system images |
| `quay.io` | k0s components (calico, metrics-server) |
| `docker.io` | Some third-party images |
| `gcr.io` | Google Container Registry images |

The implementation should allow configuring additional registries dynamically based on the bundle contents.

## Configuration from k0rdentd Config

The registry mirror address should be configurable via the k0rdentd config file:

```yaml
airgap:
  registry:
    address: "127.0.0.1:5000"  # For single-node
    # address: "192.168.1.10:5000"  # For multi-worker
```

## References

- [k0s Runtime Documentation](https://docs.k0sproject.io/stable/runtime/)
- [k0s Airgap Installation](https://docs.k0sproject.io/stable/airgap-install/)
- [containerd Registry Configuration](https://github.com/containerd/containerd/blob/main/docs/hosts.md)
