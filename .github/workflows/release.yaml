name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          # Online flavor builds
          - goarch: amd64
            flavor: online
          - goarch: arm64
            flavor: online
          # Airgap flavor builds
          - goarch: amd64
            flavor: airgap
          - goarch: arm64
            flavor: airgap
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'
          cache: true

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Build binary
        env:
          GOARCH: ${{ matrix.goarch }}
          VERSION: ${{ steps.get_version.outputs.VERSION }}
        run: |
          if [ "${{ matrix.flavor }}" = "airgap" ]; then
            make build-airgap
            binary_name="k0rdentd-airgap"
          else
            make build
            binary_name="k0rdentd"
          fi
          echo "BINARY_NAME=${binary_name}" >> $GITHUB_ENV

      - name: Create archive
        id: create_archive
        run: |
          version="${{ steps.get_version.outputs.VERSION }}"
          arch="${{ matrix.goarch }}"
          flavor="${{ matrix.flavor }}"
          
          if [ "${flavor}" = "airgap" ]; then
            archive_name="k0rdentd-airgap-${version}-linux-${arch}.tar.gz"
            binary_name="k0rdentd-airgap"
          else
            archive_name="k0rdentd-${version}-linux-${arch}.tar.gz"
            binary_name="k0rdentd"
          fi
          
          # Create archive directory
          mkdir -p dist/k0rdentd
          cp bin/${binary_name} dist/k0rdentd/
          cp README.md dist/k0rdentd/ 2>/dev/null || true
          cp LICENSE dist/k0rdentd/ 2>/dev/null || true
          
          # Create archive
          cd dist
          tar -czf "${archive_name}" k0rdentd/
          cd ..
          
          # Generate checksum
          sha256sum "dist/${archive_name}" > "dist/${archive_name}.sha256"
          
          echo "ARCHIVE_PATH=dist/${archive_name}" >> $GITHUB_OUTPUT
          echo "ARCHIVE_NAME=${archive_name}" >> $GITHUB_OUTPUT

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: k0rdentd-${{ matrix.flavor }}-${{ matrix.goarch }}
          path: |
            ${{ steps.create_archive.outputs.ARCHIVE_PATH }}
            ${{ steps.create_archive.outputs.ARCHIVE_PATH }}.sha256

  release:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          pattern: k0rdentd-*

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT

      - name: Generate release notes
        id: release_notes
        run: |
          version="${{ steps.get_version.outputs.VERSION }}"
          previous_tag=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
          
          cat > release_notes.md << 'EOF'
          ## What's Changed
          
          ### Artifacts
          
          #### Online Flavor (Default)
          Standard k0rdentd binary that downloads k0s and k0rdent from the internet during installation.
          
          | Architecture | Download | Checksum |
          |-------------|----------|----------|
          EOF
          
          # Add online artifacts
          for file in artifacts/k0rdentd-online-*/*.tar.gz; do
            if [ -f "$file" ]; then
              basename_file=$(basename "$file")
              arch=$(echo "$basename_file" | sed 's/k0rdentd-//' | sed 's/-linux-.*//' | sed 's/.*-//')
              echo "| ${arch} | [${basename_file}](${basename_file}) | [SHA256](${basename_file}.sha256) |" >> release_notes.md
            fi
          done
          
          cat >> release_notes.md << 'EOF'
          
          #### Airgap Flavor
          k0rdentd-airgap binary with embedded k0s and skopeo. For offline/air-gapped installations.
          Requires the k0rdent enterprise airgap bundle (downloaded separately).
          
          | Architecture | Download | Checksum |
          |-------------|----------|----------|
          EOF
          
          # Add airgap artifacts
          for file in artifacts/k0rdentd-airgap-*/*.tar.gz; do
            if [ -f "$file" ]; then
              basename_file=$(basename "$file")
              arch=$(echo "$basename_file" | sed 's/k0rdentd-airgap-//' | sed 's/-linux-.*//' | sed 's/.*-//')
              echo "| ${arch} | [${basename_file}](${basename_file}) | [SHA256](${basename_file}.sha256) |" >> release_notes.md
            fi
          done
          
          cat >> release_notes.md << 'EOF'
          
          ### Airgap Installation
          
          For air-gapped environments, use the `k0rdentd-airgap` binary:
          
          ```bash
          # Download the k0rdent enterprise airgap bundle separately
          # See: https://get.mirantis.com/k0rdent-enterprise/
          
          # Start the registry daemon
          sudo ./k0rdentd-airgap registry -b /path/to/airgap-bundle.tar.gz
          
          # Run installation
          sudo ./k0rdentd-airgap install --airgap
          ```
          
          ### Full Changelog
          EOF
          
          if [ -n "$previous_tag" ]; then
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${previous_tag}...${version}" >> release_notes.md
          fi
          
          cat release_notes.md

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.get_version.outputs.VERSION }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(steps.get_version.outputs.VERSION, 'rc') || contains(steps.get_version.outputs.VERSION, 'beta') || contains(steps.get_version.outputs.VERSION, 'alpha') }}
          files: |
            artifacts/k0rdentd-*/*.tar.gz
            artifacts/k0rdentd-*/*.sha256
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
